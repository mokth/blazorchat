@page "/chat"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client

<PageTitle>Chat</PageTitle>

<div class="chat-container">
    @if (!isAuthenticated && !isJoined)
    {
        <div class="join-screen">
            <div class="join-card">
                <h2>Welcome to BlazorChat</h2>
                <p class="mb-3">Please login or register to continue</p>
                <a href="/login" class="btn btn-primary mb-2 w-100">Login</a>
                <a href="/register" class="btn btn-outline-primary w-100">Register</a>
                <hr class="my-4" />
                <p class="text-muted mb-2">Or continue as guest:</p>
                <input type="text" @bind="userName" placeholder="Enter your name" class="form-control mb-3" />
                <button class="btn btn-secondary" @onclick="JoinChat">Join as Guest</button>
            </div>
        </div>
    }
    else if (!isJoined)
    {
        <div class="join-screen">
            <div class="join-card">
                <h2>Welcome @userName</h2>
                @if (isAuthenticated)
                {
                    <div class="d-flex gap-2 mb-3">
                        <a href="/profile" class="btn btn-outline-primary">Profile</a>
                        <a href="/logout" class="btn btn-outline-secondary">Logout</a>
                    </div>
                }
                <button class="btn btn-primary" @onclick="JoinChat">Join Chat</button>
            </div>
        </div>
    }
    else
    {
        @if (isAuthenticated)
        {
            <div class="top-nav">
                <span class="user-info">üë§ @userName</span>
                <div class="nav-actions">
                    <a href="/profile" class="nav-link">Profile</a>
                    <a href="/logout" class="nav-link">Logout</a>
                </div>
            </div>
        }
        @if (hubConnection?.State != HubConnectionState.Connected)
        {
            <div class="connection-status">
                <div class="alert alert-warning">
                    @if (hubConnection?.State == HubConnectionState.Reconnecting)
                    {
                        <span>üîÑ Reconnecting...</span>
                    }
                    else if (hubConnection?.State == HubConnectionState.Connecting)
                    {
                        <span>üîÑ Connecting...</span>
                    }
                    else
                    {
                        <span>‚ö†Ô∏è Connection lost. Attempting to reconnect...</span>
                    }
                </div>
            </div>
        }
        <ChatWindow 
            Messages="filteredMessages" 
            CurrentUser="@userName"
            CurrentUserId="@userId"
            OnlineUsers="onlineUsers"
            TypingUser="typingUser"
            SelectedUserId="selectedUserId"
            SelectedChatName="@selectedChatName"
            IsGroupChat="isGroupChat"
            CanSendMessages="canSendMessages"
            UnreadCounts="unreadCounts"
            OnSelectUser="EventCallback.Factory.Create<string>(this, SelectUser)"
            OnSelectGroup="EventCallback.Factory.Create(this, SelectGroup)"
            OnSendMessage="EventCallback.Factory.Create<string>(this, SendMessage)"
            OnSendImage="EventCallback.Factory.Create<(string, string)>(this, SendImage)"
            OnSendVoice="EventCallback.Factory.Create<(string, int)>(this, SendVoiceMessage)"
            OnSendFile="EventCallback.Factory.Create<(string, string)>(this, SendFile)"
            OnTyping="EventCallback.Factory.Create(this, HandleTyping)"
            OnReplyMessage="EventCallback.Factory.Create<(string, string)>(this, HandleReplyMessage)"
            OnForwardMessage="EventCallback.Factory.Create<(string, string?, bool)>(this, HandleForwardMessage)"
            OnDeleteMessage="EventCallback.Factory.Create<string>(this, HandleDeleteMessage)"
            OnClearChat="EventCallback.Factory.Create(this, HandleClearChat)" />
    }
</div>

<style>
    .top-nav {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .user-info {
        font-weight: 600;
        font-size: 1rem;
    }

    .nav-actions {
        display: flex;
        gap: 15px;
    }

    .nav-link {
        color: white;
        text-decoration: none;
        font-weight: 500;
        padding: 5px 10px;
        border-radius: 5px;
        transition: background-color 0.2s;
    }

    .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .d-flex {
        display: flex;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .btn-outline-secondary {
        border: 2px solid #6c757d;
        color: #6c757d;
        background: transparent;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-outline-secondary:hover {
        background: #6c757d;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        border: none;
        border-radius: 8px;
        padding: 12px;
        font-weight: 600;
        transition: transform 0.2s;
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
    }

    .text-muted {
        color: #6c757d !important;
    }
</style>
