@page "/chat"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client

<PageTitle>Chat</PageTitle>

<div class="chat-container">
    @if (!isAuthenticated && !isJoined)
    {
        <div class="join-screen">
            <div class="join-card">
                <h2>Welcome to BlazorChat</h2>
                <p class="mb-3">Please login or register to continue</p>
                <a href="/login" class="btn btn-primary mb-2 w-100">Login</a>
                <a href="/register" class="btn btn-outline-primary w-100">Register</a>
                <hr class="my-4" />
                <p class="text-muted mb-2">Or continue as guest:</p>
                <input type="text" @bind="userName" placeholder="Enter your name" class="form-control mb-3" />
                <button class="btn btn-secondary" @onclick="JoinChat">Join as Guest</button>
            </div>
        </div>
    }
    else if (!isJoined)
    {
        <div class="join-screen">
            <div class="join-card">
                <h2>Welcome @userName</h2>
                <button class="btn btn-primary" @onclick="JoinChat">Join Chat</button>
            </div>
        </div>
    }
    else
    {
        @if (hubConnection?.State != HubConnectionState.Connected)
        {
            <div class="connection-status">
                <div class="alert alert-warning">
                    @if (hubConnection?.State == HubConnectionState.Reconnecting)
                    {
                        <span>üîÑ Reconnecting...</span>
                    }
                    else if (hubConnection?.State == HubConnectionState.Connecting)
                    {
                        <span>üîÑ Connecting...</span>
                    }
                    else
                    {
                        <span>‚ö†Ô∏è Connection lost. Attempting to reconnect...</span>
                    }
                </div>
            </div>
        }
        <ChatWindow 
            Messages="filteredMessages" 
            CurrentUser="@userName"
            CurrentUserId="@userId"
            OnlineUsers="onlineUsers"
            TypingUser="typingUser"
            SelectedUserId="selectedUserId"
            SelectedChatName="@selectedChatName"
            IsGroupChat="isGroupChat"
            CanSendMessages="canSendMessages"
            UnreadCounts="unreadCounts"
            OnSelectUser="EventCallback.Factory.Create<string>(this, SelectUser)"
            OnSelectGroup="EventCallback.Factory.Create(this, SelectGroup)"
            OnSendMessage="EventCallback.Factory.Create<string>(this, SendMessage)"
            OnSendImage="EventCallback.Factory.Create<(string, string)>(this, SendImage)"
            OnSendVoice="EventCallback.Factory.Create<(string, int)>(this, SendVoiceMessage)"
            OnSendFile="EventCallback.Factory.Create<(string, string)>(this, SendFile)"
            OnTyping="EventCallback.Factory.Create(this, HandleTyping)"
            OnReplyMessage="EventCallback.Factory.Create<(string, string)>(this, HandleReplyMessage)"
            OnForwardMessage="EventCallback.Factory.Create<(string, string?, bool)>(this, HandleForwardMessage)"
            OnDeleteMessage="EventCallback.Factory.Create<string>(this, HandleDeleteMessage)"
            OnClearChat="EventCallback.Factory.Create(this, HandleClearChat)" />
    }
</div>
