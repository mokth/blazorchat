@page "/chat"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using blazorchat.Models
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Chat</PageTitle>

<div class="chat-container">
    @if (!isJoined)
    {
        <div class="join-screen">
            <div class="join-card">
                <h2>Welcome to BlazorChat</h2>
                <input type="text" @bind="userName" placeholder="Enter your name" class="form-control mb-3" />
                <button class="btn btn-primary" @onclick="JoinChat">Join Chat</button>
            </div>
        </div>
    }
    else
    {
        @if (hubConnection?.State != HubConnectionState.Connected)
        {
            <div class="connection-status">
                <div class="alert alert-warning">
                    @if (hubConnection?.State == HubConnectionState.Reconnecting)
                    {
                        <span>üîÑ Reconnecting...</span>
                    }
                    else if (hubConnection?.State == HubConnectionState.Connecting)
                    {
                        <span>üîÑ Connecting...</span>
                    }
                    else
                    {
                        <span>‚ö†Ô∏è Connection lost. Attempting to reconnect...</span>
                    }
                </div>
            </div>
        }
        <ChatWindow 
            Messages="messages" 
            CurrentUser="@userName"
            OnlineUsers="onlineUsers"
            TypingUser="typingUser"
            OnSendMessage="EventCallback.Factory.Create<string>(this, SendMessage)"
            OnSendImage="EventCallback.Factory.Create<(string, string)>(this, SendImage)"
            OnSendVoice="EventCallback.Factory.Create<(string, int)>(this, SendVoiceMessage)"
            OnSendFile="EventCallback.Factory.Create<(string, string)>(this, SendFile)"
            OnTyping="EventCallback.Factory.Create(this, HandleTyping)" />
    }
</div>

@code {
    private HubConnection? hubConnection;
    private List<ChatMessage> messages = new();
    private List<User> onlineUsers = new();
    private string userName = "";
    private string userId = Guid.NewGuid().ToString();
    private bool isJoined = false;
    private string typingUser = "";
    private System.Threading.Timer? typingTimer;

    protected override async Task OnInitializedAsync()
    {
        // Check for URL parameters (for WebForm integration)
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        var userIdParam = query["userId"];
        var userNameParam = query["userName"];

        if (!string.IsNullOrEmpty(userIdParam))
        {
            userId = userIdParam;
        }

        if (!string.IsNullOrEmpty(userNameParam))
        {
            userName = userNameParam;
        }

        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
            .WithAutomaticReconnect(new[] { TimeSpan.Zero, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(10) })
            .Build();

        // Handle reconnection events
        hubConnection.Reconnecting += error =>
        {
            Console.WriteLine("Connection lost. Attempting to reconnect...");
            InvokeAsync(StateHasChanged);
            return Task.CompletedTask;
        };

        hubConnection.Reconnected += async connectionId =>
        {
            Console.WriteLine("Reconnected successfully. Rejoining chat...");
            if (isJoined && !string.IsNullOrEmpty(userName))
            {
                // Rejoin the chat after reconnection
                await hubConnection.SendAsync("UserConnected", userId, userName);
            }
            InvokeAsync(StateHasChanged);
        };

        hubConnection.Closed += async error =>
        {
            Console.WriteLine($"Connection closed: {error?.Message}");
            // Try to restart after a delay
            await Task.Delay(5000);
            if (hubConnection.State == HubConnectionState.Disconnected)
            {
                try
                {
                    await hubConnection.StartAsync();
                    if (isJoined && !string.IsNullOrEmpty(userName))
                    {
                        await hubConnection.SendAsync("UserConnected", userId, userName);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error restarting connection: {ex.Message}");
                }
            }
            InvokeAsync(StateHasChanged);
        };

        hubConnection.On<List<ChatMessage>>("LoadMessages", (loadedMessages) =>
        {
            messages = loadedMessages;
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<ChatMessage>("ReceiveMessage", (message) =>
        {
            messages.Add(message);
            InvokeAsync(StateHasChanged);
            InvokeAsync(async () => await JSRuntime.InvokeVoidAsync("scrollToBottom"));
        });

        hubConnection.On<string>("UserConnected", (user) =>
        {
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("UserDisconnected", (user) =>
        {
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<List<User>>("UpdateUserList", (users) =>
        {
            onlineUsers = users;
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("UserTyping", (user) =>
        {
            typingUser = user;
            InvokeAsync(StateHasChanged);
            
            // Clear typing indicator after 3 seconds
            typingTimer?.Dispose();
            typingTimer = new System.Threading.Timer(_ =>
            {
                typingUser = "";
                InvokeAsync(StateHasChanged);
            }, null, 3000, Timeout.Infinite);
        });

        await hubConnection.StartAsync();
    }

    private async Task JoinChat()
    {
        if (!string.IsNullOrWhiteSpace(userName) && hubConnection is not null)
        {
            isJoined = true;
            await hubConnection.SendAsync("UserConnected", userId, userName);
        }
    }

    private async Task SendMessage(string message)
    {
        if (hubConnection is not null && !string.IsNullOrWhiteSpace(message))
        {
            await hubConnection.SendAsync("SendMessage", userName, message);
        }
    }

    private async Task SendImage((string imageData, string fileName) data)
    {
        if (hubConnection is not null && hubConnection.State == HubConnectionState.Connected)
        {
            try
            {
                await hubConnection.SendAsync("SendImage", userName, data.imageData, data.fileName);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error sending image: {ex.Message}");
            }
        }
    }

    private async Task SendVoiceMessage((string audioData, int duration) data)
    {
        if (hubConnection is not null && hubConnection.State == HubConnectionState.Connected)
        {
            try
            {
                await hubConnection.SendAsync("SendVoiceMessage", userName, data.audioData, data.duration);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error sending voice message: {ex.Message}");
            }
        }
    }

    private async Task SendFile((string fileData, string fileName) data)
    {
        if (hubConnection is not null && hubConnection.State == HubConnectionState.Connected)
        {
            try
            {
                await hubConnection.SendAsync("SendFile", userName, data.fileData, data.fileName);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error sending file: {ex.Message}");
            }
        }
    }

    private async Task HandleTyping()
    {
        if (hubConnection is not null)
        {
            await hubConnection.SendAsync("UserTyping", userName);
        }
    }

    public async ValueTask DisposeAsync()
    {
        typingTimer?.Dispose();
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
