@inject IJSRuntime JSRuntime

<div class="voice-recorder">
    @if (!IsRecording)
    {
        <button class="btn-record" @onclick="StartRecording">
            üé§ Start Recording
        </button>
    }
    else
    {
        <div class="recording-controls">
            <span class="recording-time">@recordingTime</span>
            <button class="btn-stop" @onclick="StopRecording">
                ‚èπÔ∏è Stop
            </button>
        </div>
    }
</div>

@code {
    [Parameter] public EventCallback<(string audioData, int duration)> OnVoiceRecorded { get; set; }
    
    private bool IsRecording = false;
    private string recordingTime = "0:00";
    private int recordingSeconds = 0;
    private System.Threading.Timer? timer;

    private async Task StartRecording()
    {
        IsRecording = true;
        recordingSeconds = 0;
        
        timer = new System.Threading.Timer(_ =>
        {
            recordingSeconds++;
            recordingTime = $"{recordingSeconds / 60}:{recordingSeconds % 60:D2}";
            InvokeAsync(StateHasChanged);
        }, null, 0, 1000);

        await JSRuntime.InvokeVoidAsync("startVoiceRecording");
    }

    private async Task StopRecording()
    {
        IsRecording = false;
        timer?.Dispose();

        var audioData = await JSRuntime.InvokeAsync<string>("stopVoiceRecording");
        if (!string.IsNullOrEmpty(audioData))
        {
            await OnVoiceRecorded.InvokeAsync((audioData, recordingSeconds));
        }

        recordingSeconds = 0;
        recordingTime = "0:00";
    }
}
