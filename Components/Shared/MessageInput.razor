@inject IJSRuntime JS

<div class="message-input-container">
    <div class="input-actions">
        <label class="action-button" title="Upload Image">
            <input type="file" accept="image/*" @onchange="HandleImageUpload" style="display: none;" />
            <span>üñºÔ∏è</span>
        </label>
        
        <label class="action-button" title="Upload File">
            <input type="file" @onchange="HandleFileUpload" style="display: none;" />
            <span>üìé</span>
        </label>
        
        <button class="action-button" @onclick="ToggleVoiceRecording" title="@(isRecording ? "Stop Recording" : "Voice Message")">
            <span>@(isRecording ? "‚èπÔ∏è" : "üé§")</span>
        </button>
    </div>
    
    <div class="text-input-wrapper">
        <input 
            type="text" 
            @bind="messageText" 
            @bind:event="oninput"
            @onkeypress="HandleKeyPress"
            placeholder="Type a message..."
            class="message-input" 
            disabled="@isRecording" />
    </div>
    
    <button class="send-button" @onclick="SendMessageAsync" disabled="@(!CanSend)">
        <span>üì§</span>
    </button>
</div>

@code {
    [Parameter] public EventCallback<string> OnSendMessage { get; set; }
    [Parameter] public EventCallback<(string imageData, string fileName)> OnSendImage { get; set; }
    [Parameter] public EventCallback<(string audioData, int duration)> OnSendVoice { get; set; }
    [Parameter] public EventCallback<(string fileData, string fileName)> OnSendFile { get; set; }
    [Parameter] public EventCallback OnTyping { get; set; }

    private string messageText = string.Empty;
    private bool isRecording = false;
    private bool CanSend => !string.IsNullOrWhiteSpace(messageText) && !isRecording;

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && CanSend)
        {
            await SendMessageAsync();
        }
    }

    private async Task HandleTyping()
    {
        await OnTyping.InvokeAsync();
    }

    private async Task SendMessageAsync()
    {
        if (CanSend)
        {
            await OnSendMessage.InvokeAsync(messageText);
            messageText = string.Empty;
        }
    }

    private async Task HandleImageUpload(ChangeEventArgs e)
    {
        var file = e.Value?.ToString();
        if (!string.IsNullOrEmpty(file))
        {
            try
            {
                var imageData = await JS.InvokeAsync<string>("readFileAsBase64", file);
                var fileName = Path.GetFileName(file);
                await OnSendImage.InvokeAsync((imageData, fileName));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading image: {ex.Message}");
            }
        }
    }

    private async Task HandleFileUpload(ChangeEventArgs e)
    {
        var file = e.Value?.ToString();
        if (!string.IsNullOrEmpty(file))
        {
            try
            {
                var fileData = await JS.InvokeAsync<string>("readFileAsBase64", file);
                var fileName = Path.GetFileName(file);
                await OnSendFile.InvokeAsync((fileData, fileName));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading file: {ex.Message}");
            }
        }
    }

    private async Task ToggleVoiceRecording()
    {
        if (!isRecording)
        {
            await StartRecording();
        }
        else
        {
            await StopRecording();
        }
    }

    private async Task StartRecording()
    {
        try
        {
            await JS.InvokeVoidAsync("startVoiceRecording");
            isRecording = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting recording: {ex.Message}");
        }
    }

    private async Task StopRecording()
    {
        try
        {
            var result = await JS.InvokeAsync<VoiceRecordingResult>("stopVoiceRecording");
            isRecording = false;
            
            if (!string.IsNullOrEmpty(result.AudioData))
            {
                await OnSendVoice.InvokeAsync((result.AudioData, result.Duration));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error stopping recording: {ex.Message}");
            isRecording = false;
        }
    }

    public class VoiceRecordingResult
    {
        public string AudioData { get; set; } = string.Empty;
        public int Duration { get; set; }
    }
}
