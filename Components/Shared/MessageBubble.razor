<div class="message-bubble @(IsCurrentUser ? "sent" : "received") @(IsGrouped ? "grouped" : "")">
    @if (!IsGrouped)
    {
        <div class="message-header">
            <span class="message-user">@Message.User</span>
        </div>
    }

    <div class="message-content">
        @if (!string.IsNullOrEmpty(Message.ReplyToMessageId) && ReplyToMessage != null)
        {
            <div class="reply-preview">
                <div class="reply-bar"></div>
                <div class="reply-content">
                    <span class="reply-user">@ReplyToMessage.User</span>
                    <span class="reply-text">@GetReplyPreviewText(ReplyToMessage)</span>
                </div>
            </div>
        }
        
        @if (!string.IsNullOrEmpty(Message.ForwardedFromMessageId))
        {
            <div class="forwarded-label">
                <span>â†ª Forwarded</span>
            </div>
        }

        @switch (Message.Type)
        {
            case MessageType.Text:
                <p>@Message.Content</p>
                break;

            case MessageType.Image:
                <div class="message-image">
                    <img src="@Message.Content" alt="@Message.FileName" />
                    @if (!string.IsNullOrEmpty(Message.FileName))
                    {
                        <p class="file-name">@Message.FileName</p>
                    }
                </div>
                break;

            case MessageType.Voice:
                <div class="message-voice">
                    <audio controls>
                        <source src="@Message.Content" type="audio/webm">
                        <source src="@Message.Content" type="audio/ogg">
                        Your browser does not support audio playback.
                    </audio>
                    @if (Message.Duration.HasValue)
                    {
                        <span class="voice-duration">@FormatDuration(Message.Duration.Value)</span>
                    }
                </div>
                break;

            case MessageType.File:
                <div class="message-file">
                    <div class="file-icon">ðŸ“„</div>
                    <div class="file-info">
                        <a href="@Message.Content" download="@Message.FileName" class="file-name">@Message.FileName</a>
                        <p class="file-action">Click to download</p>
                    </div>
                </div>
                break;
        }
    </div>

    <div class="message-footer">
        <span class="message-time">@Message.Timestamp.ToLocalTime().ToString("HH:mm")</span>
        @if (IsCurrentUser && Message.IsDelivered)
        {
            <span class="message-status">âœ“âœ“</span>
        }
    </div>

    <div class="message-actions">
        <button class="action-btn" @onclick="HandleReply" title="Reply">
            <span>â†©</span>
        </button>
        <button class="action-btn" @onclick="HandleForward" title="Forward">
            <span>â†ª</span>
        </button>
        @if (IsCurrentUser)
        {
            <button class="action-btn delete-btn" @onclick="HandleDelete" title="Delete">
                <span>ðŸ—‘</span>
            </button>
        }
    </div>
</div>
