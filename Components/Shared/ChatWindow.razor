<div class="chat-window">
    <div class="chat-header">
        <div class="chat-title">
            <h3>@SelectedChatName</h3>
            <span class="chat-mode">@ChatModeLabel</span>
        </div>
        <div class="chat-header-actions">
            <button class="mobile-userlist-toggle"
                    type="button"
                    aria-label="Show contacts"
                    aria-expanded="@IsMobileUserListOpen"
                    @onclick="ToggleMobileUserList">
                Contacts
            </button>
            <span class="online-count">@OnlineUsers.Count online</span>
        </div>
    </div>

    <div class="chat-main">
        <div class="mobile-overlay @(IsMobileUserListOpen ? "is-visible" : "")" @onclick="CloseMobileUserList"></div>
        <div class="sidebar @(IsMobileUserListOpen ? "is-open" : "")">
            <div class="sidebar-header">
                <span>Contacts</span>
                <button type="button" class="sidebar-close" @onclick="CloseMobileUserList" aria-label="Close contacts">
                    âœ•
                </button>
            </div>
            <UserList Users="OnlineUsers"
                      CurrentUserId="CurrentUserId"
                      SelectedUserId="SelectedUserId"
                      IsGroupSelected="IsGroupChat"
                      UnreadCounts="UnreadCounts"
                      OnSelectUser="HandleSelectUser"
                      OnSelectGroup="HandleSelectGroup" />
        </div>

        <div class="chat-content">
            <div class="messages-container" id="messagesContainer">
                @if (Messages.Count == 0)
                {
                    <div class="no-messages">
                        @if (!CanSendMessages)
                        {
                            <p>Select a contact to start a 1:1 chat or choose Group Chat.</p>
                        }
                        else
                        {
                            <p>No messages yet. Start the conversation!</p>
                        }
                    </div>
                }
                else
                {
                    string? lastUser = null;
                    DateTime? lastTime = null;

                    @foreach (var message in Messages)
                    {
                        bool isGrouped = lastUser == message.User && 
                                       lastTime.HasValue && 
                                       (message.Timestamp - lastTime.Value).TotalMinutes < 1;

                        bool isMine = message.SenderId == CurrentUserId;

                        <div class="@(isMine ? "msg-right" : "msg-left")">
                            <MessageBubble 
                                Message="message" 
                                IsCurrentUser="@isMine"
                                IsGrouped="isGrouped" />
                        </div>

                        lastUser = message.User;
                        lastTime = message.Timestamp;
                    }
                }

                @if (!string.IsNullOrEmpty(TypingUser))
                {
                    <div class="typing-indicator">
                        <span>@TypingUser is typing...</span>
                    </div>
                }
            </div>

            <MessageInput 
                CanSend="CanSendMessages"
                Placeholder='@(CanSendMessages ? "Type a message..." : "Select a contact to start chatting")'
                OnSendMessage="OnSendMessage"
                OnSendImage="OnSendImage"
                OnSendVoice="OnSendVoice"
                OnSendFile="OnSendFile"
                OnTyping="OnTyping" />
        </div>
    </div>
</div>
