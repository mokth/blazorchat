<div class="chat-window">
    <div class="chat-header">
        <div class="chat-title">
            <h3>@SelectedChatName</h3>
            <span class="chat-mode">@ChatModeLabel</span>
        </div>
        <div class="chat-header-actions">
            @if (CanSendMessages)
            {
                <button class="clear-chat-btn" @onclick="HandleClearChat" title="Clear chat">
                    ðŸ—‘ Clear Chat
                </button>
            }
            <button class="mobile-userlist-toggle"
                    type="button"
                    aria-label="Show contacts"
                    aria-expanded="@IsMobileUserListOpen"
                    @onclick="ToggleMobileUserList">
                Contacts
            </button>
            <span class="online-count">@OnlineUsers.Count online</span>
        </div>
    </div>

    <div class="chat-main">
        <div class="mobile-overlay @(IsMobileUserListOpen ? "is-visible" : "")" @onclick="CloseMobileUserList"></div>
        <div class="sidebar @(IsMobileUserListOpen ? "is-open" : "")">
            <div class="sidebar-header">
                <span>Contacts</span>
                <button type="button" class="sidebar-close" @onclick="CloseMobileUserList" aria-label="Close contacts">
                    âœ•
                </button>
            </div>
            <UserList Users="OnlineUsers"
                      Groups="Groups"
                      CurrentUserId="CurrentUserId"
                      SelectedUserId="SelectedUserId"
                      SelectedGroupId="SelectedGroupId"
                      IsGroupSelected="IsGroupChat"
                      UnreadCounts="UnreadCounts"
                      OnSelectUser="HandleSelectUser"
                      OnSelectGroup="HandleSelectGroup"
                      OnSelectPrivateGroup="OnSelectPrivateGroup"
                      OnCreateGroupClick="OnCreateGroupClick" />
        </div>

        <div class="chat-content">
            @if (ReplyToMessage != null)
            {
                <div class="reply-banner">
                    <div class="reply-banner-content">
                        <span class="reply-banner-label">Replying to @ReplyToMessage.User</span>
                        <span class="reply-banner-text">@GetMessagePreview(ReplyToMessage)</span>
                    </div>
                    <button class="reply-banner-close" @onclick="CancelReply">âœ•</button>
                </div>
            }

            <div class="messages-container" id="messagesContainer">
                @if (Messages.Count == 0)
                {
                    <div class="no-messages">
                        @if (!CanSendMessages)
                        {
                            <p>Select a contact to start a 1:1 chat or choose Group Chat.</p>
                        }
                        else
                        {
                            <p>No messages yet. Start the conversation!</p>
                        }
                    </div>
                }
                else
                {
                    string? lastUser = null;
                    DateTime? lastTime = null;

                    @foreach (var message in Messages)
                    {
                        bool isGrouped = lastUser == message.User && 
                                       lastTime.HasValue && 
                                       (message.Timestamp - lastTime.Value).TotalMinutes < 1;

                        bool isMine = message.SenderId == CurrentUserId;
                        var replyToMsg = GetReplyToMessage(message.ReplyToMessageId);

                        <div class="@(isMine ? "msg-right" : "msg-left")">
                            <MessageBubble 
                                Message="message" 
                                IsCurrentUser="@isMine"
                                IsGrouped="isGrouped"
                                ReplyToMessage="replyToMsg"
                                OnReply="HandleReply"
                                OnForward="HandleForward"
                                OnDelete="HandleDeleteMessage" />
                        </div>

                        lastUser = message.User;
                        lastTime = message.Timestamp;
                    }
                }

                @if (!string.IsNullOrEmpty(TypingUser))
                {
                    <div class="typing-indicator">
                        <span>@TypingUser is typing...</span>
                    </div>
                }
            </div>

            <MessageInput 
                CanSend="CanSendMessages"
                Placeholder='@(CanSendMessages ? "Type a message..." : "Select a contact to start chatting")'
                OnSendMessage="HandleSendMessage"
                OnSendImage="OnSendImage"
                OnSendVoice="OnSendVoice"
                OnSendFile="OnSendFile"
                OnTyping="OnTyping" />
        </div>
    </div>

    @if (ShowForwardDialog)
    {
        <div class="modal-overlay" @onclick="CloseForwardDialog">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h4>Forward Message</h4>
                    <button class="modal-close" @onclick="CloseForwardDialog">âœ•</button>
                </div>
                <div class="modal-body">
                    <p>Select a contact to forward this message:</p>
                    <div class="contact-list">
                        <button class="contact-item" @onclick="() => ForwardToGroup()">
                            <span class="contact-name">Group Chat</span>
                        </button>
                        @foreach (var user in OnlineUsers.Where(u => u.Id != CurrentUserId))
                        {
                            <button class="contact-item" @onclick="() => ForwardToUser(user.Id)">
                                <span class="contact-name">@user.Name</span>
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>
