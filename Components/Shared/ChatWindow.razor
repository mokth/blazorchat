@using blazorchat.Models

<div class="chat-window">
    <div class="chat-header">
        <div class="chat-title">
            <h3>@SelectedChatName</h3>
            <span class="chat-mode">@ChatModeLabel</span>
        </div>
        <span class="online-count">@OnlineUsers.Count online</span>
    </div>

    <div class="chat-main">
        <div class="sidebar">
            <UserList Users="OnlineUsers"
                      CurrentUserId="CurrentUserId"
                      SelectedUserId="SelectedUserId"
                      IsGroupSelected="IsGroupChat"
                      UnreadCounts="UnreadCounts"
                      OnSelectUser="OnSelectUser"
                      OnSelectGroup="OnSelectGroup" />
        </div>

        <div class="chat-content">
            <div class="messages-container" id="messagesContainer">
                @if (Messages.Count == 0)
                {
                    <div class="no-messages">
                        @if (!CanSendMessages)
                        {
                            <p>Select a contact to start a 1:1 chat or choose Group Chat.</p>
                        }
                        else
                        {
                            <p>No messages yet. Start the conversation!</p>
                        }
                    </div>
                }
                else
                {
                    string? lastUser = null;
                    DateTime? lastTime = null;

                    @foreach (var message in Messages)
                    {
                        bool isGrouped = lastUser == message.User && 
                                       lastTime.HasValue && 
                                       (message.Timestamp - lastTime.Value).TotalMinutes < 1;

                        bool isMine = message.SenderId == CurrentUserId;

                        <div class="@(isMine ? "msg-right" : "msg-left")">
                            <MessageBubble 
                                Message="message" 
                                IsCurrentUser="@isMine"
                                IsGrouped="isGrouped" />
                        </div>

                        lastUser = message.User;
                        lastTime = message.Timestamp;
                    }
                }

                @if (!string.IsNullOrEmpty(TypingUser))
                {
                    <div class="typing-indicator">
                        <span>@TypingUser is typing...</span>
                    </div>
                }
            </div>

            <MessageInput 
                CanSend="CanSendMessages"
                Placeholder='@(CanSendMessages ? "Type a message..." : "Select a contact to start chatting")'
                OnSendMessage="OnSendMessage"
                OnSendImage="OnSendImage"
                OnSendVoice="OnSendVoice"
                OnSendFile="OnSendFile"
                OnTyping="OnTyping" />
        </div>
    </div>
</div>

@code {
    [Parameter] public List<ChatMessage> Messages { get; set; } = new();
    [Parameter] public string CurrentUser { get; set; } = "";
    [Parameter] public string CurrentUserId { get; set; } = "";
    [Parameter] public List<User> OnlineUsers { get; set; } = new();
    [Parameter] public string TypingUser { get; set; } = "";
    [Parameter] public string? SelectedUserId { get; set; }
    [Parameter] public string SelectedChatName { get; set; } = "Select a contact";
    [Parameter] public bool IsGroupChat { get; set; }
    [Parameter] public bool CanSendMessages { get; set; }
    [Parameter] public Dictionary<string, int> UnreadCounts { get; set; } = new();
    [Parameter] public EventCallback<string> OnSelectUser { get; set; }
    [Parameter] public EventCallback OnSelectGroup { get; set; }
    [Parameter] public EventCallback<string> OnSendMessage { get; set; }
    [Parameter] public EventCallback<(string imageData, string fileName)> OnSendImage { get; set; }
    [Parameter] public EventCallback<(string audioData, int duration)> OnSendVoice { get; set; }
    [Parameter] public EventCallback<(string fileData, string fileName)> OnSendFile { get; set; }
    [Parameter] public EventCallback OnTyping { get; set; }

    private string ChatModeLabel => IsGroupChat ? "Group Chat" : "1:1 Chat";

    protected override void OnParametersSet()
    {
        Console.WriteLine($"ChatWindow - CurrentUser: '{CurrentUser}', Messages: {Messages.Count}");
        if (Messages.Any())
        {
            Console.WriteLine($"First message user: '{Messages[0].User}'");
        }
    }
}
